function [RawData_list] = Reformat(Data, PlateRow, ArrayType, PercentExclude)
% Greg Koytiger June 2011
% Ethan and Alexis, May 20th 2009
% Input: Data = cell array with three columns consisting of the formatted
% ArrayPro data, a 6 element peptide probe vector, and one element for the
% highest concentration point
% PlateRow = row of data from Data to use
% The well layout, SH2 names, and Peptide names files are also included
% here.
% Thioredoxin background spot is 501 for Odd Arrays and 500 for Even Arrays

    Probes = Data{PlateRow,2}(:,1);
    RawData = Data{PlateRow,1};
    Wells = RawData(:,1);
    Columns = RawData(:,3);
    Rows = RawData(:,2);
    Cy5 = RawData(:,4);
    Cy3 = RawData(:,5:7);
    Cy3_blownout = zeros(length(RawData),3);
    Cy3_blownout(:,1:2) = RawData(:,8:9)> 65000;%this specifies that anything > 65000 at its max 2 intensities density has blown out pixels;

%These specify the two different spot printings that cover all SH2 domains
% ArrayType 1 is normal current array layout with Thioredoxin used on the
% Odd Array
if ArrayType == 1

SH2Layout_Odd = [11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31];

SH2Layout_Even = [149	173	128	1118	196	183	121	21	34	247	210	217	223	228	232	237	244
149	173	128	1118	196	183	121	21	34	247	210	217	223	228	232	237	244
149	173	128	1118	196	183	121	21	34	247	210	217	223	228	232	237	244
149	173	128	1118	196	183	121	21	34	247	210	217	223	228	232	237	244
150	1110	127	171	193	1125	138	22	246	27	211	220	224	36	233	240	500
150	1110	127	171	193	1125	138	22	246	27	211	220	224	36	233	240	500
150	1110	127	171	193	1125	138	22	246	27	211	220	224	36	233	240	500
150	1110	127	171	193	1125	138	22	246	27	211	220	224	36	233	240	500
192	1111	167	1000	159	125	33	245	25	28	214	221	226	230	234	1121	186
192	1111	167	1000	159	125	33	245	25	28	214	221	226	230	234	1121	186
192	1111	167	1000	159	125	33	245	25	28	214	221	226	230	234	1121	186
192	1111	167	1000	159	125	33	245	25	28	214	221	226	230	234	1121	186
148	120	117	160	179	166	177	23	26	29	215	222	35	231	236	243	32
148	120	117	160	179	166	177	23	26	29	215	222	35	231	236	243	32
148	120	117	160	179	166	177	23	26	29	215	222	35	231	236	243	32
148	120	117	160	179	166	177	23	26	29	215	222	35	231	236	243	32];

end



% ArrayType 2 is an inverted normal current array layout 

if ArrayType == 2
    
SH2Layout_Even = [31	191	1112	18	112	16	137	188	136	1124	115	1113	194	118	146	1102	198
31	191	1112	18	112	16	137	188	136	1124	115	1113	194	118	146	1102	198
31	191	1112	18	112	16	137	188	136	1124	115	1113	194	118	146	1102	198
31	191	1112	18	112	16	137	188	136	1124	115	1113	194	118	146	1102	198
501	187	161	17	162	15	195	169	119	116	144	19	163	1120	218	1107	197
501	187	161	17	162	15	195	169	119	116	144	19	163	1120	218	1107	197
501	187	161	17	162	15	195	169	119	116	144	19	163	1120	218	1107	197
501	187	161	17	162	15	195	169	119	116	144	19	163	1120	218	1107	197
142	165	184	114	1115	14	1109	185	1117	1123	1100	126	111	190	1114	199	13
142	165	184	114	1115	14	1109	185	1117	1123	1100	126	111	190	1114	199	13
142	165	184	114	1115	14	1109	185	1117	1123	1100	126	111	190	1114	199	13
142	165	184	114	1115	14	1109	185	1117	1123	1100	126	111	190	1114	199	13
139	151	172	113	170	141	189	147	1119	182	12	145	122	110	1116	1106	11
139	151	172	113	170	141	189	147	1119	182	12	145	122	110	1116	1106	11
139	151	172	113	170	141	189	147	1119	182	12	145	122	110	1116	1106	11
139	151	172	113	170	141	189	147	1119	182	12	145	122	110	1116	1106	11];

SH2Layout_Odd = [32	243	236	231	35	222	215	29	26	23	177	166	179	160	117	120	148
32	243	236	231	35	222	215	29	26	23	177	166	179	160	117	120	148
32	243	236	231	35	222	215	29	26	23	177	166	179	160	117	120	148
32	243	236	231	35	222	215	29	26	23	177	166	179	160	117	120	148
186	1121	234	230	226	221	214	28	25	245	33	125	159	1000	167	1111	192
186	1121	234	230	226	221	214	28	25	245	33	125	159	1000	167	1111	192
186	1121	234	230	226	221	214	28	25	245	33	125	159	1000	167	1111	192
186	1121	234	230	226	221	214	28	25	245	33	125	159	1000	167	1111	192
500	240	233	36	224	220	211	27	246	22	138	1125	193	171	127	1110	150
500	240	233	36	224	220	211	27	246	22	138	1125	193	171	127	1110	150
500	240	233	36	224	220	211	27	246	22	138	1125	193	171	127	1110	150
500	240	233	36	224	220	211	27	246	22	138	1125	193	171	127	1110	150
244	237	232	228	223	217	210	247	34	21	121	183	196	1118	128	173	149
244	237	232	228	223	217	210	247	34	21	121	183	196	1118	128	173	149
244	237	232	228	223	217	210	247	34	21	121	183	196	1118	128	173	149
244	237	232	228	223	217	210	247	34	21	121	183	196	1118	128	173	149];

end

% ArrayType 3 is an older layout of array used by Andrew Gordus 

if ArrayType == 3

SH2Layout_Odd = [11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
11	1106	1116	110	122	145	12	182	1119	147	189	141	170	113	172	151	139
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
13	199	1114	190	111	126	1100	1123	1117	185	1109	14	1115	114	184	165	142
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
197	1107	218	1120	163	19	144	116	119	169	195	15	162	17	161	187	501
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31
198	1102	146	118	194	1113	115	1124	136	188	137	16	112	18	1112	191	31];
    
SH2Layout_Even = [149	173	128	1118	196	183	121	21	24	247	210	217	223	228	232	237	244
149	173	128	1118	196	183	121	21	24	247	210	217	223	228	232	237	244
149	173	128	1118	196	183	121	21	24	247	210	217	223	228	232	237	244
149	173	128	1118	196	183	121	21	24	247	210	217	223	228	232	237	244
150	1110	127	171	193	1125	138	22	246	27	211	220	224	229	233	240	500
150	1110	127	171	193	1125	138	22	246	27	211	220	224	229	233	240	500
150	1110	127	171	193	1125	138	22	246	27	211	220	224	229	233	240	500
150	1110	127	171	193	1125	138	22	246	27	211	220	224	229	233	240	500
192	1111	167	1000	159	125	1121	245	25	28	214	221	226	230	234	242	186
192	1111	167	1000	159	125	1121	245	25	28	214	221	226	230	234	242	186
192	1111	167	1000	159	125	1121	245	25	28	214	221	226	230	234	242	186
192	1111	167	1000	159	125	1121	245	25	28	214	221	226	230	234	242	186
148	120	117	160	179	166	177	23	26	29	215	222	503	231	236	243	32
148	120	117	160	179	166	177	23	26	29	215	222	503	231	236	243	32
148	120	117	160	179	166	177	23	26	29	215	222	503	231	236	243	32
148	120	117	160	179	166	177	23	26	29	215	222	503	231	236	243	32];

end

%This specifies the layout of the different concentrations in the 96 well
%plate
ConcentrationLayout = [8	8	8	8	8	8	8	8	8	8	8	8
7	7	7	7	7	7	7	7	7	7	7	7
6	6	6	6	6	6	6	6	6	6	6	6
5	5	5	5	5	5	5	5	5	5	5	5
4	4	4	4	4	4	4	4	4	4	4	4
3	3	3	3	3	3	3	3	3	3	3	3
2	2	2	2	2	2	2	2	2	2	2	2
1	1	1	1	1	1	1	1	1	1	1	1];

%This next section creates the Probe layout in the 96 well plate
probe_temp = [Probes(1) Probes(1) Probes(2) Probes(2) Probes(3) Probes(3) Probes(4) Probes(4) Probes(5) Probes(5) Probes(6) Probes(6)];
ProbesLayout = [probe_temp;probe_temp;probe_temp;probe_temp;probe_temp;probe_temp;probe_temp;probe_temp];

%Create the well layout for the numbering scheme used in ArrayPro
WellLayout = [1	2	3	4	5	6	7	8	9	10	11	12
13	14	15	16	17	18	19	20	21	22	23	24
25	26	27	28	29	30	31	32	33	34	35	36
37	38	39	40	41	42	43	44	45	46	47	48
49	50	51	52	53	54	55	56	57	58	59	60
61	62	63	64	65	66	67	68	69	70	71	72
73	74	75	76	77	78	79	80	81	82	83	84
85	86	87	88	89	90	91	92	93	94	95	96];

%Initialize list of all interactions
RawData_list = zeros(size(RawData,1),6);
%RawData_list has elements of:
%SH2# PEP# conc Cy3 Cy5 Background_Cy3



%Convert all lower intensity spots so that they are on they are of the same
%magnitude as the high intensity

conversionmatrix = Cy3(intersect(find(Cy3_blownout(:,1)==0),find(Cy3_blownout(:,2)==0)), 1:3);
conversionfactor2to1 = polyfit(conversionmatrix(:,2), conversionmatrix(:,1), 1);
conversionfactor3to1 = polyfit(conversionmatrix(:,3), conversionmatrix(:,1), 1);

Converted_Cy3 = zeros(length(Cy3),3);
Converted_Cy3(:,1) = Cy3(:,1);
Converted_Cy3(:,2) = Cy3(:,2)*conversionfactor2to1(1)+conversionfactor2to1(2);
Converted_Cy3(:,3) = Cy3(:,3)*conversionfactor3to1(1)+conversionfactor3to1(2);

Merged_Cy3 = zeros(length(RawData),1);

%Uses the plate maps to find which spots correspond to which
%domain & peptide & concentration

for listI = 1:size(RawData,1)
    [rowI,columnI] = find(WellLayout == Wells(listI));
    average_vector = Converted_Cy3(listI, :);
    blownout_vector = Cy3_blownout(listI, :);       

    %Generate the best Cy3 value by merging all values that are not blown out
    Merged_Cy3(listI) = trimmean(average_vector(blownout_vector == 0), PercentExclude);   
    
    if mod(Wells(listI),2) == 0 %determine which WellLayout to use if even or odd well
        
        RawData_list(listI,1:5) = [SH2Layout_Even(Rows(listI),Columns(listI)) ProbesLayout(rowI,columnI) ConcentrationLayout(rowI,columnI) ...
           Merged_Cy3(listI) Cy5(listI)];


    else
        
        RawData_list(listI,1:5) = [SH2Layout_Odd(Rows(listI),Columns(listI)) ProbesLayout(rowI,columnI) ConcentrationLayout(rowI,columnI) ...
            Merged_Cy3(listI) Cy5(listI)];


    end
end

%Generates the average background for each spot
RawData_list(:,6) = findBackground(RawData_list, Wells, PercentExclude);
RawData_list(RawData_list(:,5) == 0, 5) = 0.1; %Prevents Cy5 from being 0

end
